@[TOC]

# 前言

> 在迭代任务繁多、需求紧张、需求复杂的情况下，有时候开发人员为了追赶需求，而不考虑设计模式、设计原则、系统性能等，给系统埋了很多坑，欠下了许多技术债。当系统性能达到用户无法接受的程度，往往这个时候领导才意识到要安排一个性能优化的任务给开发，然后进行一些代码重构。下面介绍我所了解的Java性能优化的一些技术手段以及我在实际项目中遇到的问题和优化手段。

# 性能优化的7种技术手段

系统优化从大方向来说可以分为两类：业务优化和技术优化，前者是产品经理或者BA所关注的方向，后者是开发所关注的方向。目前常见的系统优化策略大致可分为以下7类：
![性能优化的几种手段](https://img-blog.csdnimg.cn/2020080215004840.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzIyNzk3NDI5,size_16,color_FFFFFF,t_70)

## 复用优化

复用的思想主要分为对代码逻辑上的优化、数据存储上的优化、池化技术，代码逻辑上的优化我们经常用到，比如某个公共的方法被多个地方调用，我们可以把它抽取出来放到Util里面供系统调用。而数据存储的复用，我们会想到两个方式：缓冲和缓存。

- 缓冲（Buffer）：对数据的暂存，主要是针对的是写操作
- 缓存（Cache）：对频繁访问的数据放到相对高速的区域，缓存主要针对的是读操作

对象的池化技术，我们在平常项目中也经常用到，比如数据库连接池、线程池等。由于对象的创建、销毁成本比较大，我们在使用之后，将它暂存起来，下次用的时候就不必再创建了，节省了对象创建以及后续初始化操作。

## 计算优化

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200802152428661.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzIyNzk3NDI5,size_16,color_FFFFFF,t_70)
如上图，计算优化可分为并行优化、异步、惰性加载

### 并行优化

相对于CPU密集型场景，为了加快某个任务快速完成，可以让它并行执行，并行执行又可以分为以下三种：

- 多线程：通过线程池启动多个线程并发执行任务，比如Netty，采用Reactor编程模型，采用NIO，但是它是基于线程的
- 多进程：比如Nginx采用了NIO编程模型，Master统一管理Worker进程，然后由Worker进程进行真正的请求代理
- 集群：采用集群的方式将大流量或者大型计算拆分成多个部分，多个部分同时进行处理等。比如Redis集群、Hadoop集群

### 异步执行

同步方式请求会一直阻塞，直到成功或者失败才有结果返回，同步方式在某个时间段突发流量会出现很大问题，请求容易失败。而异步操作可以方便支持横向扩展、使得请求变得更加平滑。

### 惰性加载

惰性加载，在被使用的时候再进行加载来优化业务，提高体验。如单例模式的懒汉模式。

## 结果集优化

### 压缩体积
为什么xml这么好，还用json传输呢，其中一个重要的原因就是体积变小了，传输效率和解析效率变高。

### 结果集精简
像Nginx，一般都会开启GZIP压缩，使得传输的内容保持紧凑，一些客户端不需要的字段或者查询，那么之直接在代码中或者sql的查询中去掉。如在MyBatis中返回格式尽量不要使用SELECT * 这种，要精确到某几个字段，一些不需要的字段在SQL查询中，把它过滤掉。

### 采用批量处理的方式
采用批量处理的方式，尽量减少网络连接的交互、开销，尽量在一次数据库连接中拿到所想用的数据，但是也不能进行多个连接查询，阿里规范中提到数据库表连接不能超过3个。

### 索引优化

在频繁查询条件的地方增加索引，当然索引也不是越多越好，能够用到组合索引的地方尽量用组合索引，这样可以减少一个索引开销

## 资源冲突优化

在平时开发中涉及到很多共享资源问题，在并发访问下，同一时刻要求只有一个请求获得共享资源，解决资源冲突场景就是加入适当的锁。

## 算法优化

算法优化能够提高复杂业务的性能，提高系统响应速度。算法优化涉及到对算法、数据结构的灵活使用，属于代码优化的方式。根据不同的场景选择适当的算法来降低时间复杂度。
比如常用的降低时间复杂度的方式，就有递归、二分、排序、动态规划。比如我们在单线程中使用StringBuilder要比使用StringBuffer性能要高的多。比如我们在数组随机访问方面采用ArrayList要比LinkedList要快的多。
再比如，我们采用CopyOnWriteList写时复制的方式，可以显著降低读多写少场景下的锁冲突。

## 高效实现

针对不同的业务场景选择最适合项目的组件，比如在进行大数据日志的实时计算与日志采集，选择kafka比选择rabbitMQ更合适

## JVM优化

对JVM参数进行一定的优化可以提升系统性能，需要对GC 的类型和工作机制有深入了解，对各种 JVM 参数很熟悉。

# 项目中应用

## 应用一：发邮件和工具类

在项目中，我们需要完成多个需求阶段下不同发邮件模板的封装，重构之前代码比较乱，这里写个发邮件，那里写个发邮件，没有统一和抽象，我们采用模板方法模式和建造者模式对代码进行了重构，一个父接口某人指定一些默认方法，通过不同的子类实现接口重写父类的defalut
method，在子类中根据不同的type进行不同对象的构建传入FreeMaker模板中

在公用方法、常量等工具类我们放到constants类中

在数据库读操作比较频繁、更新比较少的一些数据，我们统一放到redis中，下次直接从缓存中取数据。

## 应用二：数据库性能优化

数据库性能优化分为3个方面：

- 数据库索引优化 对一些条件查询增加相应的索引，通过explain看是否命中索引，能用复合索引的地方尽量用复合索引，可以减少一个索引
- 数据库连接优化 尽量不要在Mybatis的xml或者注解上使用使用超过3个连接的操作，我们之前有些表连接特别多，inner jon、left join、right join超过10个是常有的事，这也是操作系统瓶颈的一方面
- 尽量使用数据库分页而不是内存分页 使用内存分页在数据量不多的情况下用户是无感知的，当数据量增加上去，里面又牵扯了许多复杂逻辑，就会导致页面非常卡，所以在列表数据特别多的情况下，还是建议使用数据库分页，不然也是系统瓶颈的一方面

# 小结

本文主要从7个方面讲述了Java性能优化的技术手段、并且结合项目实战进行分析，以后系统遇到瓶颈可以从这几个方面进行切入。