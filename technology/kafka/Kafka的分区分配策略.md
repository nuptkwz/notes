# 前言

> 在分布式消息系统 Kafka 中，分区分配策略是影响消费者组性能和数据处理效率的核心机制之一。本文将深入剖析 Kafka 的三种主要分区分配策略 —— Range 分配、RoundRobin 分配和 Sticky 分配，结合实际案例分析它们的原理、优缺点以及适用场景，同时探讨重新分配的触发条件，帮助技术从业者在实际项目中做出更明智的选择。

# Kafka的分区分配策略概述

Kafka 提供了三种分区分配策略，旨在满足不同业务场景下消费者组对分区资源的合理分配需求。

Kafka的3种分区分配策略分别为：

1. range范围（默认）
2. roundRobin 轮询
3. sticky粘性

## range范围（默认）

它是Kafka默认的一种分配方式，它的原理是把消费者总数和分区总数做一个整除运算，来进行一个平均分配，它会把消费者组内，所有订阅这个Topic的消费者按照一个
字典序排序，然后把这些分区，平均的分配给消费者，如果它有余数的话，那么它将会把字典数排序靠前的消费者多分配一个分区。 举个例子： 有两个topic(Topic1,Topic2)
,有两个消费者（A1，A2），每个主题上有2个分区，具体的分配策略如下：
![Kafka分区分配策略_Range范围_2个分区.png](./images/分区分配策略/Kafka分区分配策略_Range范围_2个分区.png)

这样一看，我们感觉它分配的也均匀。但是这个均匀会一直这样下去吗？或者说在任何情况下都能分配均匀吗？我们再来看另一种情况： 有两个topic(Topic1,Topic2),有两个消费者（A1，A2），每个主题上有3个分区，具体的分配策略如下：
![Kafka分区分配策略_Range范围_3个分区.png](./images/分区分配策略/Kafka分区分配策略_Range范围_3个分区.png)

很明显可以看到，这个分配方式是不均匀的，如果说这种情况再进行一个扩大，很可能会造成消费者压力过大。

## roundRobin 轮询

实现原理：它是把消费者组内所有的消费者以及消费者所订阅的Topic都进行字典排序，然后通过轮询的方式逐个的把这些分区，分配给每个消费者，如Kafka分区分配策略_roundRobin轮询_3个分区 所示：
![Kafka分区分配策略_roundRobin轮询_3个分区.png](./images/分区分配策略/Kafka分区分配策略_roundRobin轮询_3个分区.png)

如上所示，每个消费者消费的分区都是相同的，但是这仅仅在它两个都订阅了这两个topic，在消费者订阅的topic相同的情况下，他才能进行一个均匀的分配，如果说它订阅的 不相同的话，它会怎么样呢？

如下所示：有两个topic(Topic1,Topic2，Topic3),有3个消费者（A1，A2，A3），每个主题上的分区如下，比如：

- A1订阅了Topic1
- A2订阅了Topic1,Topic2
- A3订阅了Topic1,Topic2,Topic3

具体的分配策略如下：
![Kafka分区分配策略_roundRobin轮询_消费者订阅的分区不相同.png](./images/分区分配策略/Kafka分区分配策略_roundRobin轮询_消费者订阅的分区不相同.png)

## sticky粘性

粘性分区分配策略，它主要有两个目的：

1. 分区分配尽可能地要均匀
2. 分区分配要尽可能的跟上次保持相同（主题分区尽可能地保留在其先前分配的消费者中）

粘性分区分配策略是从Kafka 0.11.x版本之后引进的，如果两个目的发生冲突了，分区分配均匀这个目的要优先于保持相同这个目的 如下所示：有两个topic(Topic1,Topic2，Topic3)
,有3个消费者（A1，A2，A3），每个主题上的分区如下，比如：

- A1订阅了Topic1
- A2订阅了Topic1,Topic2
- A3订阅了Topic1,Topic2,Topic3

采用粘性策略的分配如下：
![Kafka分区分配策略_粘性_消费者订阅的分区不相同.png](./images/分区分配策略/Kafka分区分配策略_粘性_消费者订阅的分区不相同.png)

可以看到，这就是一个最优的解了，A1订阅了Topic1所以它消费了Topic1，A2订阅了Topic1,Topic2因为Topic1已经被消费了，所以A2消费Topic2的消息，同理A3
消费了Topic3的消息。

这样分配是比较合理的，但是此时，突然有一个消费者脱离了消费者组，比如说A1挂掉了或者说它脱离了，那么此时它会怎样分配呢？


# 什么时候用到分区分配策略？

那我们什么时候要用到这个分区分配策略呢？ 主要有两点：

1. 一个消费者组，它里面的消费者进行新增或者减少的时候，它会进行一个重新分配，如果新增的话，它会把分区进行一个重新分配，如果减少的话，也会进行一个重新分配
2. topic分区发生变化的时候，也会进行重新分配

# 总结与展望
深入理解 Kafka 的分区分配策略对于优化消息消费性能、保障系统稳定性和提高资源利用率具有至关重要的意义。Range 分配策略凭借其简单易懂和快速分配的特点，在分区数量与消费者数量能够较好匹配的场景下表现出色；RoundRobin 分配策略适用于消费者订阅 Topic 相同且追求分区均匀分配的场景，但在消费者订阅 Topic 多样化时可能面临挑战；Sticky 分配策略则在兼顾分区分配均匀性和稳定性方面展现出独特的优势，尤其适用于对分区分配连续性要求较高的业务场景。

随着大数据技术的不断发展和企业对实时数据处理需求的日益增长，Kafka 作为分布式消息系统的代表，将在更多领域发挥关键作用。未来，我们可以期待 Kafka 在分区分配策略方面进行进一步的优化和创新，例如引入更加智能的机器学习算法来预测分区分配需求，或者提供更灵活的自定义分区分配策略配置选项，以更好地满足复杂多变的企业级应用需求。同时，开发者和运维人员也应持续关注 Kafka 的技术演进，不断提升自身对分区分配策略的理解和应用能力，从而在实际项目中充分挖掘 Kafka 的性能潜力，构建高效、可靠的消息处理系统。